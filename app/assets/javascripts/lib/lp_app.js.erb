(function() {
  window.lp = window.lp || {};
  window.lp.rizzo = (function($) {
    var self = {};
    if (window.lp && lp.ads){
      self.adZone = window.lp.ads.adZone;
      self.adKeywords = window.lp.ads.adKeywords;
      self.tile = window.lp.ads.tile;
      self.segQS = window.lp.ads.segQS;
      self.mtfIFPath = window.lp.ads.mtfIFPath || '/';
    }
    
    self.init = function() {
      self.onLoad();
    };

    self.onLoad = function(){
      var _this_ = this;
      if (window.addEventListener){
        window.addEventListener('load', function(){_this_.start();},false);
      } else if (window.attachEvent){
        window.attachEvent('onload', function(){_this_.start();});
      }
    };

    self.start = function() {
      //TODO: dependencies loading
      self.loadRequired("<%= javascript_path('application.js') %>");
      self.initUserStatus();
      self.initShoppingCart();
      // self.initBreadcrumbs();
      self.bindEvents();
      self.initLeaderBoard();
      self.initDestinationsNav();
    };

    self.loadRequired = function(_required){
      var _c = document.createElement('script');
      _c.src = _required;
      _c.async = true;
      var _s = document.getElementsByTagName('script')[0];
      _s.parentNode.insertBefore(_c, _s);
    };

    self.initDestinationsNav = function(){
      var _c = document.createElement('script');
      _c.src = "http://www.lonelyplanet.com/global-navigation";
      _c.async = true;
      var _s = document.getElementsByTagName('script')[0];
      _s.parentNode.insertBefore(_c, _s);
    };

    self.initUserStatus = function(){
      var lpLoggedInUsername;
      var auth = new Lp.Authentication();
      window.auth = auth;
      var script = document.createElement('script');
      script.src = "https://secure.lonelyplanet.com/sign-in/status";
      script.async = true;
      script.onload = script.onreadystatechange = function(){auth.update();};
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.appendChild(script, s);
    };
    
    self.initShoppingCart = function(){
      var itemCount = 0;
      var cartData = $.cookies.get("shopCartCookie");
      if (cartData !== null && cartData.A !== undefined) {
        itemCount = cartData.A.length;
      }
      $("nav.primary ul li.globalCartHead a").html("Cart: " + itemCount);
    };

    self.initLeaderBoard = function(unit, target){
      var iframe = document.createElement('iframe');
      ord=Math.random()*10000000000000000;
      iframe.src = 'http://ad.doubleclick.net/adi/2009.lonelyplanet/' + self.adZone + ';' + self.adKeywords + ';' + self.segQS + ';' +  'tile=' + self.tile + ';' + 'mtfIFPath=' + self.mtfIFPath + ';sz=728x90;ord=' + ord + '?';
      iframe.marginHeight="0";
      iframe.marginWidth="0";
      iframe.frameBorder="0";
      iframe.scrolling='no';
      iframe.style.height = '90px';
      iframe.style.width = '728px';
      var s = document.getElementById('ad_masthead');
      s.appendChild(iframe);
    };
    
    self.initBreadcrumbs = function(){
      jQuery(document).ready(function($){
        var location = window.location;
        breadcrumbSelector = "#breadcrumb";
        try {
          jQuery.ajax({
            type: "GET",
            url: "<%= asset_path('breadcrumbs.html') %>?destId=357884",
            contentType: "text/xml",
            dataType: "html",
            cache: true,
            success: function(html) {
              jQuery("#breadcrumbWrap").replaceWith(html);
      
              var breadcrumbBar = new BreadcrumbBar(jQuery(breadcrumbSelector));
              var a = new BreadcrumbResizer();
            }
          });
        } catch(err) {
        }
      });
    };

    self.bindEvents =  function(){
      $("#language").removeClass('javascriptDisabled');
      $("#languageSelect").change(function() {
        $("#language").submit();
      });
    };

    return self;
    });

  new window.lp.rizzo(jQuery).init();
}).call(this);

